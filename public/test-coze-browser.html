<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coze APIæµ‹è¯• - æµè§ˆå™¨ç¯å¢ƒ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .warning {
            background: #fff3cd;
            border-color: #ffeeba;
            color: #856404;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            font-family: monospace;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        .config-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .config-item {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .ascii-test {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Coze API æµè§ˆå™¨ç¯å¢ƒæµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•æµè§ˆå™¨ç¯å¢ƒä¸‹çš„Coze APIè¿æ¥é—®é¢˜</p>
    </div>

    <div class="container">
        <h2>ğŸ“‹ APIé…ç½®</h2>
        <div class="config-section">
            <div class="config-item">
                <label for="apiKey">Coze APIå¯†é’¥:</label>
                <textarea id="apiKey" placeholder="è¾“å…¥æ‚¨çš„Coze APIå¯†é’¥">sat_yMrCtDDJ3hu75OVifEOLi1UXBtd6w75P5m6oTczqgo8sRfdT4McCotEnaZ9I9swr</textarea>
            </div>
            <div class="config-item">
                <label for="botId">Bot ID:</label>
                <input type="text" id="botId" placeholder="è¾“å…¥Bot ID" value="7557346656962953270">
            </div>
            <div class="config-item">
                <label for="baseUrl">Base URL:</label>
                <input type="text" id="baseUrl" placeholder="APIåŸºç¡€URL" value="https://api.coze.cn">
            </div>
            <div class="config-item">
                <label for="userQuery">æµ‹è¯•æ¶ˆæ¯:</label>
                <textarea id="userQuery" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯">Hello, can you explain PageRank algorithm?</textarea>
            </div>
        </div>
        
        <div class="ascii-test">
            <button onclick="testAscii()">ğŸ”¤ æ£€æµ‹ASCIIå­—ç¬¦</button>
            <span id="asciiResult"></span>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ§ª è¿æ¥æµ‹è¯•</h2>
        
        <div class="test-section">
            <h3>1. DNSå’Œç½‘ç»œè¿æ¥æµ‹è¯•</h3>
            <button onclick="testDNS()">ğŸŒ æµ‹è¯•DNSè§£æ</button>
            <button onclick="testCORS()">ğŸ”’ æµ‹è¯•CORS</button>
            <div id="networkResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>2. APIå¯†é’¥éªŒè¯</h3>
            <button onclick="testAPIKey()">ğŸ”‘ éªŒè¯APIå¯†é’¥</button>
            <div id="authResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>3. å®Œæ•´èŠå¤©æµ‹è¯•</h3>
            <button onclick="testChat()">ğŸ’¬ æµ‹è¯•èŠå¤©åŠŸèƒ½</button>
            <div id="chatResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>4. é”™è¯¯åˆ†æ</h3>
            <button onclick="analyzeErrors()">ğŸ” åˆ†æé”™è¯¯</button>
            <div id="errorAnalysis" class="result" style="display:none;"></div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“Š æµè§ˆå™¨ç¯å¢ƒä¿¡æ¯</h2>
        <div id="browserInfo" class="result"></div>
    </div>

    <script>
        // å·¥å…·å‡½æ•°
        function isAsciiOnly(str) {
            for (let i = 0; i < str.length; i++) {
                if (str.charCodeAt(i) > 127) {
                    return false;
                }
            }
            return true;
        }

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        function logResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.textContent += `[${timestamp}] ${message}\n`;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        // ASCIIå­—ç¬¦æ£€æµ‹
        function testAscii() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const result = isAsciiOnly(apiKey);
            const element = document.getElementById('asciiResult');
            
            if (result) {
                element.textContent = 'âœ… APIå¯†é’¥åªåŒ…å«ASCIIå­—ç¬¦';
                element.className = 'success';
            } else {
                element.textContent = 'âŒ APIå¯†é’¥åŒ…å«éASCIIå­—ç¬¦';
                element.className = 'error';
            }
        }

        // DNSå’Œç½‘ç»œè¿æ¥æµ‹è¯•
        async function testDNS() {
            const baseUrl = document.getElementById('baseUrl').value.trim();
            showResult('networkResult', 'æ­£åœ¨æµ‹è¯•DNSè§£æ...', 'info');
            
            try {
                // æµ‹è¯•åŸºæœ¬è¿æ¥
                const response = await fetch(`${baseUrl}/v3/bot/get_online_bots`, {
                    method: 'GET',
                    mode: 'no-cors', // å…ˆæµ‹è¯•æ— CORSæ¨¡å¼
                    cache: 'no-cache'
                });
                
                logResult('networkResult', 'DNSè§£æ: âœ… æˆåŠŸ', 'success');
                logResult('networkResult', 'HTTPè¿æ¥: âœ… æˆåŠŸ', 'success');
                
            } catch (error) {
                logResult('networkResult', `DNS/è¿æ¥æµ‹è¯•: âŒ å¤±è´¥ - ${error.message}`, 'error');
            }
        }

        // CORSæµ‹è¯•
        async function testCORS() {
            const baseUrl = document.getElementById('baseUrl').value.trim();
            showResult('networkResult', 'æ­£åœ¨æµ‹è¯•CORS...', 'info');
            
            try {
                // æµ‹è¯•å¸¦CORSçš„è¯·æ±‚
                const response = await fetch(`${baseUrl}/v3/bot/get_online_bots`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    cache: 'no-cache'
                });
                
                logResult('networkResult', `CORSçŠ¶æ€: ${response.ok ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`, response.ok ? 'success' : 'error');
                logResult('networkResult', `å“åº”çŠ¶æ€: ${response.status}`, 'info');
                
                // æ£€æŸ¥å“åº”å¤´
                const headers = Object.fromEntries(response.headers.entries());
                logResult('networkResult', `å“åº”å¤´: ${JSON.stringify(headers, null, 2)}`, 'info');
                
            } catch (error) {
                if (error.message.includes('CORS')) {
                    logResult('networkResult', `CORSé”™è¯¯: âŒ ${error.message}`, 'error');
                    logResult('networkResult', 'å»ºè®®: æ£€æŸ¥æœåŠ¡å™¨CORSé…ç½®', 'warning');
                } else {
                    logResult('networkResult', `CORSæµ‹è¯•: âŒ å¤±è´¥ - ${error.message}`, 'error');
                }
            }
        }

        // APIå¯†é’¥éªŒè¯
        async function testAPIKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const baseUrl = document.getElementById('baseUrl').value.trim();
            showResult('authResult', 'æ­£åœ¨éªŒè¯APIå¯†é’¥...', 'info');
            
            if (!isAsciiOnly(apiKey)) {
                showResult('authResult', 'âŒ APIå¯†é’¥åŒ…å«éASCIIå­—ç¬¦ï¼Œè¯·å…ˆä¿®å¤', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${baseUrl}/v3/bot/get_online_bots`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    cache: 'no-cache'
                });
                
                const data = await response.text();
                
                if (response.ok) {
                    logResult('authResult', 'âœ… APIå¯†é’¥éªŒè¯æˆåŠŸ', 'success');
                    logResult('authResult', `å“åº”æ•°æ®: ${data.substring(0, 200)}...`, 'info');
                } else {
                    logResult('authResult', `âŒ APIå¯†é’¥éªŒè¯å¤±è´¥ - HTTP ${response.status}`, 'error');
                    logResult('authResult', `å“åº”æ•°æ®: ${data}`, 'error');
                }
                
            } catch (error) {
                logResult('authResult', `âŒ APIå¯†é’¥éªŒè¯å¤±è´¥ - ${error.message}`, 'error');
            }
        }

        // å®Œæ•´èŠå¤©æµ‹è¯•
        async function testChat() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const botId = document.getElementById('botId').value.trim();
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const userQuery = document.getElementById('userQuery').value.trim();
            
            showResult('chatResult', 'æ­£åœ¨æµ‹è¯•èŠå¤©åŠŸèƒ½...', 'info');
            
            if (!isAsciiOnly(apiKey)) {
                showResult('chatResult', 'âŒ APIå¯†é’¥åŒ…å«éASCIIå­—ç¬¦ï¼Œè¯·å…ˆä¿®å¤', 'error');
                return;
            }
            
            const payload = {
                bot_id: botId,
                user: 'user',
                stream: false,
                query: userQuery,
                custom_variables: {
                    graph_data: JSON.stringify({
                        nodes: [
                            {id: "A", rank: 0.33, label: "A"},
                            {id: "B", rank: 0.33, label: "B"},
                            {id: "C", rank: 0.34, label: "C"}
                        ],
                        links: [
                            {source: "A", target: "B", weight: 1},
                            {source: "B", target: "C", weight: 1},
                            {source: "C", target: "A", weight: 1}
                        ],
                        algo: "pagerank",
                        currentIteration: 0,
                        maxIterations: 10,
                        dampingFactor: 0.85,
                        threshold: 0.0001
                    }),
                    algo: "pagerank",
                    language: "zh",
                    detail_level: "detailed"
                },
                additional_messages: [{
                    role: 'user',
                    content_type: 'text',
                    content: userQuery
                }]
            };
            
            try {
                logResult('chatResult', 'å‘é€è¯·æ±‚åˆ°Coze API...', 'info');
                logResult('chatResult', `è¯·æ±‚è´Ÿè½½: ${JSON.stringify(payload, null, 2)}`, 'info');
                
                const response = await fetch(`${baseUrl}/v3/chat`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload),
                    cache: 'no-cache'
                });
                
                const data = await response.text();
                logResult('chatResult', `å“åº”çŠ¶æ€: ${response.status}`, response.ok ? 'success' : 'error');
                logResult('chatResult', `å“åº”æ•°æ®: ${data}`, 'info');
                
                if (response.ok) {
                    try {
                        const jsonData = JSON.parse(data);
                        if (jsonData.code === 0) {
                            logResult('chatResult', 'âœ… èŠå¤©æµ‹è¯•æˆåŠŸï¼', 'success');
                        } else {
                            logResult('chatResult', `âŒ Coze APIé”™è¯¯: ${jsonData.msg} (ä»£ç : ${jsonData.code})`, 'error');
                        }
                    } catch (e) {
                        logResult('chatResult', 'å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼', 'error');
                    }
                }
                
            } catch (error) {
                logResult('chatResult', `âŒ èŠå¤©æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                logResult('chatResult', `é”™è¯¯ç±»å‹: ${error.name}`, 'error');
            }
        }

        // é”™è¯¯åˆ†æ
        function analyzeErrors() {
            showResult('errorAnalysis', 'æ­£åœ¨åˆ†æå¯èƒ½çš„é”™è¯¯åŸå› ...', 'info');
            
            const analysis = `ğŸ” é”™è¯¯åˆ†æç»“æœ:

1. **ç½‘ç»œè¿æ¥é—®é¢˜**:
   - DNSè§£æå¤±è´¥
   - ç½‘ç»œè¶…æ—¶
   - é˜²ç«å¢™é˜»æ­¢

2. **CORSè·¨åŸŸé—®é¢˜**:
   - æœåŠ¡å™¨æœªé…ç½®CORSå¤´
   - æµè§ˆå™¨å®‰å…¨ç­–ç•¥é˜»æ­¢
   - éœ€è¦ä»£ç†æœåŠ¡å™¨

3. **APIå¯†é’¥é—®é¢˜**:
   - å¯†é’¥æ ¼å¼é”™è¯¯
   - å¯†é’¥æƒé™ä¸è¶³
   - å¯†é’¥å·²è¿‡æœŸ

4. **è¯·æ±‚æ ¼å¼é—®é¢˜**:
   - JSONæ ¼å¼é”™è¯¯
   - ç¼ºå°‘å¿…è¦å­—æ®µ
   - å­—æ®µç±»å‹é”™è¯¯

5. **æœåŠ¡å™¨å“åº”é—®é¢˜**:
   - 500å†…éƒ¨æœåŠ¡å™¨é”™è¯¯
   - 4000ä¸šåŠ¡é”™è¯¯ä»£ç 
   - è¶…æ—¶å“åº”

**å»ºè®®è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒDNS
2. éªŒè¯APIå¯†é’¥æœ‰æ•ˆæ€§
3. æ£€æŸ¥è¯·æ±‚æ ¼å¼å’Œå‚æ•°
4. æŸ¥çœ‹æœåŠ¡å™¨CORSé…ç½®
5. ä½¿ç”¨æœåŠ¡å™¨ä»£ç†é¿å…CORSé—®é¢˜
`;
            
            showResult('errorAnalysis', analysis, 'warning');
        }

        // æ˜¾ç¤ºæµè§ˆå™¨ç¯å¢ƒä¿¡æ¯
        function showBrowserInfo() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt
                } : 'not supported',
                location: {
                    protocol: window.location.protocol,
                    hostname: window.location.hostname,
                    port: window.location.port,
                    pathname: window.location.pathname
                },
                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                screen: {
                    width: screen.width,
                    height: screen.height,
                    colorDepth: screen.colorDepth
                }
            };
            
            document.getElementById('browserInfo').textContent = JSON.stringify(info, null, 2);
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºæµè§ˆå™¨ä¿¡æ¯
        window.addEventListener('load', showBrowserInfo);
    </script>
</body>
</html>